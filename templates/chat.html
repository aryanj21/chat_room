<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="chat-container">
        <h2>Chat Room: <span id="room-code">{{ room_code }}</span></h2>
        <p>Welcome, <strong id="user-name">{{ name }}</strong></p>

        <!-- Messages Display -->
        <div id="messages" class="messages-container"></div>

        <!-- Message Input Form -->
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Type your message..." required>
            <button type="submit">Send</button>
        </form>

        <!-- Leave Room Button -->
        <button onclick="leaveRoom()" class="leave-button">Leave Room</button>
    </div>

    <script>
        const socket = io();
        const name = localStorage.getItem("name") || "{{ name }}";
        const room_code = localStorage.getItem("room_code") || "{{ room_code }}";

        // Ensure name and room_code are stored for cross-device access
        localStorage.setItem("name", name);
        localStorage.setItem("room_code", room_code);

        // Auto-join room on page load
        socket.emit("join", { name, room_code });

        // Handle incoming messages
        socket.on("message", function (data) {
            const messagesContainer = document.getElementById("messages");
            const messageElement = document.createElement("div");

            if (data.name === "System") {
                messageElement.classList.add("system-message");
            } else {
                messageElement.classList.add("user-message");
            }

            messageElement.innerHTML = `<strong>${data.name}:</strong> ${data.msg} <span class="timestamp">${data.timestamp}</span>`;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        });

        // Leave room function
        function leaveRoom() {
            socket.emit("leave", { name, room_code });

            // Clear localStorage for a fresh session
            localStorage.removeItem("name");
            localStorage.removeItem("room_code");

            window.location.href = "/";
        }
    </script>
</body>
</html>
