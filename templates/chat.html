<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>

    <div class="container">
        <h1>Group Chat</h1>
        <p><strong>Room Code:</strong> <span id="room-code">{{ room_code }}</span></p>
        <p><strong>Welcome,</strong> <span id="user-name">{{ name }}</span></p>

        <div id="chat-window" class="chat-window">
            <!-- Messages will be added dynamically here -->
        </div>

        <div class="message-box">
            <input type="text" id="message-input" placeholder="Type your message...">
            <button id="send-btn">Send</button>
        </div>

        <button id="leave-btn">Leave Room</button>
    </div>

    <script>
        const socket = io();
        let roomCode = document.getElementById("room-code").innerText;
        let userName = document.getElementById("user-name").innerText;

        // ðŸ”¹ Function to add messages to chat window
        function addMessage(name, message, timestamp) {
            const chatWindow = document.getElementById("chat-window");
            const msgDiv = document.createElement("div");

            msgDiv.classList.add("message");
            if (name === userName) {
                msgDiv.classList.add("own-message");
            }

            msgDiv.innerHTML = `<strong>${name}:</strong> ${message} <span class="timestamp">${timestamp}</span>`;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll
        }

        // ðŸ”¹ Join room
        socket.emit("join", { room_code: roomCode, name: userName });

        // ðŸ”¹ Load previous messages
        fetch(`/get-messages/${roomCode}`)
            .then(response => response.json())
            .then(data => {
                data.messages.forEach(msg => addMessage(msg.name, msg.msg, msg.timestamp));
            })
            .catch(error => console.error("Error loading messages:", error));

        // ðŸ”¹ Handle incoming messages
        socket.on("message", (data) => {
            addMessage(data.name, data.msg, data.timestamp);
        });

        // ðŸ”¹ Send message
        document.getElementById("send-btn").addEventListener("click", function () {
            const messageInput = document.getElementById("message-input");
            const message = messageInput.value.trim();

            if (message !== "") {
                socket.emit("send_message", { room_code: roomCode, name: userName, message: message });
                messageInput.value = ""; // Clear input box
            }
        });

        // ðŸ”¹ Leave room (disconnect handling)
        document.getElementById("leave-btn").addEventListener("click", function () {
            socket.emit("leave", { room_code: roomCode, name: userName });
            window.location.href = "/";
        });

        window.addEventListener("beforeunload", function () {
            socket.emit("leave", { room_code: roomCode, name: userName });
        });
    </script>

</body>
</html>
